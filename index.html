<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø£Ø¹Ù…Ø§Ù„ Ù…ÙŠÙˆØ²ØªÙƒ Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ© - ERP ÙƒØ§Ù…Ù„ 2026</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Ù…ÙƒØªØ¨Ø§Øª -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
<style>
:root { --brand:#1e3a8a; --accent:#2563eb; --ok:#059669; --bad:#dc2626; --warn:#f59e0b; --bg:#f8fafc; }
body { margin:0; font-family:'Segoe UI', Tahoma, sans-serif; background:var(--bg); color:#1e293b; padding-bottom:70px; }
header { background:var(--brand); color:#fff; padding:15px; text-align:center; font-weight:bold; position:sticky; top:0; z-index:1000; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 10px rgba(0,0,0,0.1);}
.logout-btn { background: rgba(255,255,255,0.2); padding:5px 12px; border-radius:8px; cursor:pointer; font-size:13px; }
nav { display:flex; background:#fff; border-top:1px solid #e2e8f0; position:fixed; bottom:0; width:100%; height:65px; z-index:1000; justify-content:space-around; align-items:center; }
nav button { border:none; background:none; color:#64748b; font-size:11px; font-weight:bold; cursor:pointer; flex:1; transition:0.3s; }
nav button.active { color:var(--brand); border-top:3px solid var(--brand); height:100%; }
.page { display:none; padding:15px; max-width:1000px; margin:auto; animation:fadeIn 0.3s; }
@keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
.page.active { display:block; }
.card { background:#fff; padding:18px; border-radius:15px; box-shadow:0 4px 6px -1px rgba(0,0,0,0.1); border:1px solid #e2e8f0; margin-bottom:15px; }
input, select { width:100%; padding:12px; margin:8px 0; border-radius:10px; border:1px solid #cbd5e1; font-size:15px; box-sizing:border-box; }
input:focus { border-color:var(--brand); outline:none; box-shadow:0 0 0 3px rgba(30,58,138,0.1); }
.btn-main { background:var(--brand); color:#fff; width:100%; padding:14px; border-radius:10px; border:none; font-weight:bold; cursor:pointer; }
.btn-ok { background:var(--ok); color:#fff; width:100%; padding:14px; border-radius:10px; border:none; font-weight:bold; cursor:pointer; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
th { background:#f1f5f9; padding:10px; font-size:13px; color:var(--brand); border-bottom:2px solid #e2e8f0; }
td { padding:10px; text-align:center; border-bottom:1px solid #f1f5f9; font-size:13px; }
.low-stock { background:#fee2e2; }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:2000; overflow-y:auto; padding:10px; box-sizing:border-box; }
.invoice-box { background:#fff; width:100%; max-width:210mm; margin:auto; padding:15mm; min-height:250mm; box-sizing:border-box; position:relative; }
.inv-header { display:flex; justify-content:space-between; border-bottom:3px solid var(--brand); padding-bottom:10px; }
.tax-badge { background:var(--ok); color:#fff; padding:10px; text-align:center; font-size:18px; font-weight:bold; border-radius:5px; margin:15px 0; }
.normal-badge { background:var(--brand); color:#fff; padding:10px; text-align:center; font-size:18px; font-weight:bold; border-radius:5px; margin:15px 0; }
</style>
</head>
<body>
<header>
<span>Ø£Ø¹Ù…Ø§Ù„ Ù…ÙŠÙˆØ²ØªÙƒ Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ© ğŸµ</span>
<div class="logout-btn" onclick="location.reload()">ğŸ”’ Ø®Ø±ÙˆØ¬</div>
</header>
<!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="loginView" style="padding-top:100px; text-align:center;">
<div class="card" style="max-width:350px; margin:auto;">
<h2 style="color:var(--brand);">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
<input type="password" id="entryPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
<button class="btn-main" onclick="auth()">Ø¯Ø®ÙˆÙ„</button>
</div>
</div>
<div id="appView" style="display:none;">
<!-- ØµÙØ­Ø© Ø§Ù„Ø¨ÙŠØ¹ -->
<div id="posPage" class="page active">
<div class="card">
<h3>ğŸ“‘ ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
<div style="display:flex; gap:10px;">
<input id="cName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
<input id="cPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
</div>
<select id="itemSelect" onchange="updatePriceLabel()"></select>
<div style="display:flex; gap:10px;">
<div style="flex:1">
<small id="minPriceLbl" style="color:var(--bad); font-size:10px;"></small>
<input type="number" id="sPrice" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">
</div>
<input type="number" id="sQty" value="1" style="flex:1" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
</div>
<button class="btn-ok" onclick="addToCart()">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© +</button>
<table id="cartTbl">
<thead><tr><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø­Ø°Ù</th></tr></thead>
<tbody></tbody>
</table>
<div id="cartTotalDisplay" style="text-align:center; font-size:28px; font-weight:bold; margin:15px; color:var(--brand);">0 SDG</div>
<div style="background:#fff8e1; padding:10px; border-radius:10px; border:1px solid #ffca28; margin-bottom:10px; display:flex; align-items:center;">
<input type="checkbox" id="taxToggle" style="width:20px; height:20px;" onchange="renderCart()">
<label style="font-weight:bold; margin-right:10px;">ÙØ§ØªÙˆØ±Ø© Ø¶Ø±ÙŠØ¨ÙŠØ© (17%)</label>
</div>
<input type="number" id="paidAmt" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªÙ„Ù…">
<button class="btn-main" onclick="openPreview()">ğŸ‘ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
</div>
</div>
<!-- ØµÙØ­Ø© Ø§Ù„Ù…Ø®Ø²Ù† -->
<div id="stockPage" class="page">
<div class="card">
<h3>ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²Ù†</h3>
<div style="display:flex; gap:10px;">
<input id="pBrand" placeholder="Ø§Ù„Ù…Ø§Ø±ÙƒØ©">
<input id="pModel" placeholder="Ø§Ù„Ù…Ù†ØªØ¬">
<input id="pSpec" placeholder="Ø§Ù„Ù…ÙˆØ§ØµÙØ©">
<input type="number" id="pCost" placeholder="Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ©">
<input type="number" id="pPrice" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">
<input type="number" id="pQty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
</div>
<button class="btn-ok" onclick="addProduct()">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button>
<table>
<thead><tr><th>Ø§Ù„Ù…Ø§Ø±ÙƒØ©</th><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„Ù…ÙˆØ§ØµÙØ©</th><th>Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ©</th><th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>ØªØ¹Ø¯ÙŠÙ„</th></tr></thead>
<tbody id="stockBody"></tbody>
</table>
</div>
</div>
<!-- ØµÙØ­Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
<div id="custPage" class="page">
<div class="card">
<h3>ğŸ‘¥ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3>
<table>
<thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø±ØµÙŠØ¯</th><th>ØªØ¹Ø¯ÙŠÙ„</th></tr></thead>
<tbody id="custBody"></tbody>
</table>
</div>
</div>
<!-- ØµÙØ­Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
<div id="reportsPage" class="page">
<div class="card">
<h3>ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h3>
<table>
<thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th><th>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th><th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th></tr></thead>
<tbody id="salesBody"></tbody>
</table>
</div>
</div>
<!-- ØµÙØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© -->
<div id="adminPage" class="page">
<div class="card">
<h3>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
<input id="setCompany" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©">
<input id="setAdminPass" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ±">
<input id="setStaffPass" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…ÙˆØ¸Ù">
<button class="btn-ok" onclick="saveSettings()">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
</div>
</div>
<!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
<div id="invModal" class="modal">
<div class="invoice-box" id="printableInvoice">
<div class="inv-header">    
    <div>
        <h1 style="margin:0; color:var(--brand); font-size:24px;">Ø£Ø¹Ù…Ø§Ù„ Ù…ÙŠÙˆØ²ØªÙƒ Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©</h1>
        <p style="margin:2px; font-size:11px;">MUSTECH TRADING - 130009077201 :Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ</p>
        <p style="margin:2px; font-size:11px;">Ù‡Ø§ØªÙ: 0917029008 - 0912949561</p>
    </div>
</div>
  <div style="margin:15px 0; font-size:13px;">
<strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> <span id="viewC"></span> | <strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> <span id="viewP"></span>
</div>
<table>
<thead style="background:var(--brand); color:#fff;">
<tr><th>#</th><th>Ø§Ù„Ø¨ÙŠØ§Ù†</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr>
</thead>
<tbody id="viewItems"></tbody>
</table>
<div style="display:flex; justify-content:space-between; margin-top:20px; align-items:flex-end;">
<div id="qrcode"></div>
<div style="width:200px;" id="viewSummary"></div>
</div>
<div style="margin-top:40px; text-align:center; font-size:10px; border-top:1px solid #eee; padding-top:10px;">
Ø¨Ø¶Ø§Ø¹Ø© Ù„Ø§ ØªØ±Ø¯ ÙˆÙ„Ø§ ØªØ³ØªØ¨Ø¯Ù„ Ø¨Ø¹Ø¯ 3 Ø£ÙŠØ§Ù… - Ø´ÙƒØ±Ø§Ù‹ Ù„Ø«Ù‚ØªÙƒÙ… Ø¨Ù†Ø§
</div>
</div>
<div style="text-align:center; padding:20px;" class="no-print">
<button class="btn-ok" style="width:150px; margin-bottom:5px;" onclick="processSale()">Ø­ÙØ¸ ÙˆØ¨ÙŠØ¹ âœ…</button>
<button class="btn-main" style="width:150px; margin-bottom:5px;" onclick="downloadPDF()">ØªØ­Ù…ÙŠÙ„ PDF ğŸ“¥</button>
<button onclick="invModal.style.display='none'" style="background:#94a3b8; color:#fff; padding:10px; border-radius:10px; border:none; width:150px;">Ø¥ØºÙ„Ø§Ù‚</button>
</div>
</div>
<nav id="navBar" style="display:none;">
<button onclick="nav('posPage', this)" class="active">ğŸ  Ø§Ù„Ø¨ÙŠØ¹</button>
<button onclick="nav('stockPage', this)">ğŸ“¦ Ø§Ù„Ù…Ø®Ø²Ù†</button>
<button onclick="nav('reportsPage', this)">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
<button onclick="nav('custPage', this)">ğŸ‘¥ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
<button onclick="nav('adminPage', this)">âš™ï¸ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
</nav>
<script>
// Firebase
const firebaseConfig = { apiKey:"AIzaSyABUumECfr2cnT0a3Btjf6aNhCwmlW732U", authDomain:"mustech-erp.firebaseapp.com", databaseURL:"https://mustech-erp-default-rtdb.asia-southeast1.firebasedatabase.app", projectId:"mustech-erp", storageBucket:"mustech-erp.firebasestorage.app", messagingSenderId:"961861724364", appId:"1:961861724364:web:a381a37add3569c613ba69" };
firebase.initializeApp(firebaseConfig);
const rdb = firebase.database();

let db = { items:[], sales:[], customers:[], settings:{company:"Ø£Ø¹Ù…Ø§Ù„ Ù…ÙŠÙˆØ²ØªÙƒ Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©", currency:"SDG", note:""}, config:{admin:"7878", staff:"0909"} };
let userRole=""; 
let cart=[];

// Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Firebase ÙÙˆØ±ÙŠØ§Ù‹
rdb.ref('mustech_cloud_v4').on('value', snap => { 
  if(snap.val()){ 
    db = snap.val(); 
    renderAll(); 
  } 
});

function save(){ 
  rdb.ref('mustech_cloud_v4').set(db); 
  renderAll(); 
}

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
function auth(){ 
  let p = entryPass.value; 
  if(p === db.config.admin) userRole = "admin"; 
  else if(p === db.config.staff) userRole = "staff"; 
  else return alert("Ø®Ø·Ø£ ÙÙŠ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±!"); 

  loginView.style.display="none"; 
  appView.style.display="block"; 
  navBar.style.display="flex"; 

  // ØªÙ‚ÙŠÙŠØ¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
  if(userRole === "staff"){
    document.querySelectorAll("#stockPage .btn-ok").forEach(b=>b.style.display="none");
    document.querySelectorAll("#adminPage input, #adminPage .btn-ok").forEach(e=>e.disabled=true);
  }

  renderAll(); 
}

function nav(id, btn){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  document.getElementById(id).classList.add('active'); 
  btn.classList.add('active'); 
}

// Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
function renderAll(){
  itemSelect.innerHTML=db.items.map((it,i)=>`<option value="${i}">${it.brand} ${it.name} ${it.spec} (${it.qty})</option>`).join('');
  updatePriceLabel();
  renderStock();
  renderCust();
  renderSales();
}

function updatePriceLabel(){ 
  if(!db.items[itemSelect.value]) return; 
  let it=db.items[itemSelect.value]; 
  let min=it.cost?it.cost*1.45:0; 
  minPriceLbl.innerText=it.cost?`Ø£Ø¯Ù†Ù‰ Ø³Ø¹Ø±: ${Math.ceil(min)}`:""; 
  sPrice.value=it.price||Math.ceil(min); 
}

// Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ (Ù…Ø¯ÙŠØ± ÙÙ‚Ø·)
function addProduct(){ 
  if(userRole!=="admin") return alert("ğŸš« ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·"); 
  let brand=pBrand.value.trim(), name=pModel.value.trim(), spec=pSpec.value.trim(),
      cost=+pCost.value, price=+pPrice.value, qty=+pQty.value;
  if(!brand || !name || !spec || !cost || !price || !qty) return alert("Ø§Ù…Ù„Ø£ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„!");
  db.items.push({ brand,name,spec,cost,price,qty });
  pBrand.value=pModel.value=pSpec.value=pCost.value=pPrice.value=pQty.value="";
  save(); 
}

// Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®Ø²Ù†
function renderStock(){
  stockBody.innerHTML=db.items.map(it=>`<tr class="${it.qty<3?'low-stock':''}">
  <td>${it.brand}</td><td>${it.name}</td><td>${it.spec}</td><td>${it.cost}</td><td>${it.price}</td><td>${it.qty}</td>
  ${userRole==="admin"?`<td><button onclick="editItem(${db.items.indexOf(it)})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button></td>`:""}
  </tr>`).join('');
}

// Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
function renderCust(){
  custBody.innerHTML=db.customers.map(c=>`<tr>
  <td>${c.name}</td><td>${c.phone}</td><td>${c.balance||0}</td>
  ${userRole==="admin"?`<td><button onclick="editCustomer(${db.customers.indexOf(c)})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button></td>`:""}
  </tr>`).join('');
}

// Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
function renderSales(){
  salesBody.innerHTML=db.sales.map(s=>`<tr>
  <td>${new Date(s.date).toLocaleString()}</td><td>${s.total}</td><td>${s.tax||0}</td><td>${s.paid||s.total}</td>
  </tr>`).join('');
}

// Ø³Ù„Ø© Ø§Ù„Ø¨ÙŠØ¹
function addToCart(){ 
  let it=db.items[itemSelect.value]; 
  let p=+sPrice.value; 
  let q=+sQty.value; 
  if(it.cost && p<it.cost*1.45) return alert("Ø§Ù„Ø³Ø¹Ø± Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù…Ø³Ù…ÙˆØ­!"); 
  if(q>it.qty) return alert("Ø§Ù„ÙƒÙ…ÙŠØ© ØºÙŠØ± ÙƒØ§ÙÙŠØ©!"); 
  if(it.qty<3) alert(`âš ï¸ ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ù†ØªØ¬ "${it.name}" Ù…Ù†Ø®ÙØ¶Ø©!`); 
  cart.push({...it, selP:p, selQ:q, idx:itemSelect.value}); 
  renderCart(); 
}

function renderCart(){ 
  let h='', sub=0; 
  cart.forEach((c,i)=>{ h+=`<tr><td>${c.brand} ${c.name} ${c.spec}</td><td>${c.selP}</td><td>${c.selQ}</td><td onclick="cart.splice(${i},1);renderCart()">âŒ</td></tr>`; sub+=c.selP*c.selQ; }); 
  document.querySelector('#cartTbl tbody').innerHTML=h; 
  let total=taxToggle.checked?sub*1.17:sub; 
  cartTotalDisplay.innerText=Math.ceil(total)+" "+db.settings.currency; 
}

// Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©
function openPreview(){
  if(!cart.length) return alert("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©!");
  let sub=cart.reduce((a,b)=>a+b.selP*b.selQ,0);
  let taxVal=taxToggle.checked?sub*0.17:0;
  let total=sub+taxVal;
  viewC.innerText=cName.value||"Ø¹Ù…ÙŠÙ„ Ù†Ù‚Ø¯ÙŠ";
  viewP.innerText=cPhone.value||"---";
  invDateDisplay.innerText=new Date().toLocaleString();
  invTag.className=taxToggle.checked?"tax-badge":"normal-badge";
  invTag.innerText=taxToggle.checked?"ÙØ§ØªÙˆØ±Ø© Ø¶Ø±ÙŠØ¨ÙŠØ©":"ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª";
  viewItems.innerHTML=cart.map((c,i)=>`<tr><td>${i+1}</td><td>${c.brand} ${c.name} ${c.spec}</td><td>${c.selQ}</td><td>${c.selP}</td><td>${c.selP*c.selQ}</td></tr>`).join('');

  viewSummary.innerHTML = `<table style="width:100%; font-size:12px;">
  <tr><td>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</td><td style="text-align:left;">${sub}</td></tr>
  ${taxToggle.checked?`<tr><td>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© 17%:</td><td style="text-align:left;">${Math.ceil(taxVal)}</td></tr>`:""}
  <tr style="font-weight:bold; color:var(--brand); font-size:14px; border-top:1px solid #000;">
  <td>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</td><td style="text-align:left;">${Math.ceil(total)} ${db.settings.currency}</td></tr>
  </table>`;

  qrcode.innerHTML = "";
  new QRCode(qrcode, { text: "MUSTECH-" + Math.ceil(total), width: 70, height: 70 });

  invModal.style.display = "block";
}

// Ø­ÙØ¸ ÙˆØ¨ÙŠØ¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
function processSale(){
  if(!cart.length) return alert("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©!");
  let sub = cart.reduce((a,b)=>a+b.selP*b.selQ,0);
  let taxVal = taxToggle.checked? sub*0.17 : 0;
  let total = sub + taxVal;
  let paid = paidAmt.value === "" ? total : parseFloat(paidAmt.value);

  cart.forEach(c => { db.items[c.idx].qty -= c.selQ; });

  if(cName.value && paid < total){
    if(!db.customers) db.customers=[];
    let existing = db.customers.find(cust => cust.phone === cPhone.value);
    let debt = total - paid;
    if(existing){ existing.balance += debt; }
    else{ db.customers.push({ name: cName.value, phone: cPhone.value, balance: debt }); }
  }

  if(!db.sales) db.sales=[];
  db.sales.push({ date: Date.now(), total: sub, tax: taxVal, paid: paid });

  save();
  alert("ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!");
  cart = [];
  invModal.style.display = "none";
  renderCart();
  renderCust();
}

// ØªØ­Ù…ÙŠÙ„ PDF Ù„Ù„ÙØ§ØªÙˆØ±Ø©
function downloadPDF(){
  const opt = {
    margin: 0,
    filename: 'Mustech_Invoice.pdf',
    image: { type:'jpeg', quality:0.98 },
    html2canvas: { scale:2 },
    jsPDF: { unit:'mm', format:'a4', orientation:'portrait' }
  };
  html2pdf().set(opt).from(document.getElementById('printableInvoice')).save();
}

// Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
function saveSettings(){
  if(userRole!=="admin") return alert("ğŸš« ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·"); 
  db.settings.company = setCompany.value.trim() || db.settings.company;
  if(setAdminPass.value) db.config.admin = setAdminPass.value.trim();
  if(setStaffPass.value) db.config.staff = setStaffPass.value.trim();
  save();
  alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ±!");
}

// ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Ù…Ø¯ÙŠØ± ÙÙ‚Ø·)
function editItem(idx){
  if(userRole!=="admin") return;
  let it = db.items[idx];
  let brand = prompt("Ø§Ù„Ù…Ø§Ø±ÙƒØ©:", it.brand);
  let name = prompt("Ø§Ù„Ù…Ù†ØªØ¬:", it.name);
  let spec = prompt("Ø§Ù„Ù…ÙˆØ§ØµÙØ©:", it.spec);
  let cost = prompt("Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ©:", it.cost);
  let price = prompt("Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹:", it.price);
  let qty = prompt("Ø§Ù„ÙƒÙ…ÙŠØ©:", it.qty);
  if(brand && name && spec && cost && price && qty){
    db.items[idx] = { brand,name,spec,cost:+cost,price:+price,qty:+qty };
    save();
  }
}

// ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Ù…Ø¯ÙŠØ± ÙÙ‚Ø·)
function editCustomer(idx){
  if(userRole!=="admin") return;
  let c = db.customers[idx];
  let name = prompt("Ø§Ù„Ø§Ø³Ù…:", c.name);
  let phone = prompt("Ø§Ù„Ù‡Ø§ØªÙ:", c.phone);
  let balance = prompt("Ø§Ù„Ø±ØµÙŠØ¯:", c.balance);
  if(name && phone && balance!=null){
    db.customers[idx] = { name, phone, balance:+balance };
    save();
  }
}
</script>
</body>
</html>


