<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>MUSTECH ERP v2026 - Global Cloud Edition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

    <style>
        :root { --brand: #1e3a8a; --accent: #2563eb; --ok: #059669; --bad: #dc2626; --warn: #f59e0b; --bg: #f8fafc; }
        body { margin: 0; font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: #1e293b; padding-bottom: 70px; }
        
        header { background: var(--brand); color: #fff; padding: 15px; text-align: center; font-weight: bold; position: sticky; top: 0; z-index: 1000; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .logout-btn { background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 8px; cursor: pointer; font-size: 13px; }

        nav { display: flex; background: #fff; border-top: 1px solid #e2e8f0; position: fixed; bottom: 0; width: 100%; height: 65px; z-index: 1000; justify-content: space-around; align-items: center; }
        nav button { border: none; background: none; color: #64748b; font-size: 11px; font-weight: bold; cursor: pointer; flex: 1; transition: 0.3s; }
        nav button.active { color: var(--brand); border-top: 3px solid var(--brand); height: 100%; }

        .page { display: none; padding: 15px; max-width: 1000px; margin: auto; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .page.active { display: block; }
        .card { background: #fff; padding: 18px; border-radius: 15px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; margin-bottom: 15px; }
        
        input, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #cbd5e1; font-size: 15px; box-sizing: border-box; }
        input:focus { border-color: var(--brand); outline: none; box-shadow: 0 0 0 3px rgba(30,58,138,0.1); }
        
        .btn-main { background: var(--brand); color: #fff; width: 100%; padding: 14px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; }
        .btn-ok { background: var(--ok); color: #fff; width: 100%; padding: 14px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #f1f5f9; padding: 10px; font-size: 13px; color: var(--brand); border-bottom: 2px solid #e2e8f0; }
        td { padding: 10px; text-align: center; border-bottom: 1px solid #f1f5f9; font-size: 13px; }

        /* Invoice Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; overflow-y: auto; padding: 10px; box-sizing: border-box; }
        .invoice-box { background: #fff; width: 100%; max-width: 210mm; margin: auto; padding: 15mm; min-height: 250mm; box-sizing: border-box; position: relative; }
        .inv-header { display: flex; justify-content: space-between; border-bottom: 3px solid var(--brand); padding-bottom: 10px; }
        .tax-badge { background: var(--ok); color: #fff; padding: 10px; text-align: center; font-size: 18px; font-weight: bold; border-radius: 5px; margin: 15px 0; }
        .normal-badge { background: var(--brand); color: #fff; padding: 10px; text-align: center; font-size: 18px; font-weight: bold; border-radius: 5px; margin: 15px 0; }
        .low-stock { background: #fee2e2; }
    </style>
</head>
<body>

<header>
    <span>Ø£Ø¹Ù…Ø§Ù„ Ù…ÙŠÙˆØ²ØªÙƒ Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ© ğŸµ</span>
    <div class="logout-btn" onclick="location.reload()">ğŸ”’ Ø®Ø±ÙˆØ¬</div>
</header>

<div id="loginView" style="padding-top: 100px; text-align: center;">
    <div class="card" style="max-width: 350px; margin: auto;">
        <h2 style="color: var(--brand);">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
        <input type="password" id="entryPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button class="btn-main" onclick="auth()">Ø¯Ø®ÙˆÙ„</button>
    </div>
</div>

<div id="appView" style="display: none;">
    <div id="posPage" class="page active">
        <div class="card">
            <h3>ğŸ“‘ ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
            <div style="display: flex; gap: 10px;">
                <input id="cName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
                <input id="cPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
            </div>
            <select id="itemSelect" onchange="updatePriceLabel()"></select>
            <div style="display: flex; gap: 10px;">
                <div style="flex:1">
                    <small id="minPriceLbl" style="color:var(--bad); font-size:10px;"></small>
                    <input type="number" id="sPrice" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">
                </div>
                <input type="number" id="sQty" value="1" style="flex:1" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
            </div>
            <button class="btn-ok" onclick="addToCart()">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© +</button>
            
            <table id="cartTbl">
                <thead><tr><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø­Ø°Ù</th></tr></thead>
                <tbody></tbody>
            </table>

            <div id="cartTotalDisplay" style="text-align: center; font-size: 28px; font-weight: bold; margin: 15px; color: var(--brand);">0 SDG</div>
            
            <div style="background: #fff8e1; padding: 10px; border-radius: 10px; border: 1px solid #ffca28; margin-bottom: 10px; display: flex; align-items: center;">
                <input type="checkbox" id="taxToggle" style="width: 20px; height: 20px;" onchange="renderCart()">
                <label style="font-weight: bold; margin-right: 10px;">ÙØ§ØªÙˆØ±Ø© Ø¶Ø±ÙŠØ¨ÙŠØ© (17%)</label>
            </div>

            <input type="number" id="paidAmt" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªÙ„Ù…">
            <button class="btn-main" onclick="openPreview()">ğŸ‘ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
        </div>
    </div>

    <div id="stockPage" class="page">
        <div class="card">
            <h3>ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† <span id="mgrTag" style="display:none; color:gold; font-size:12px;">(ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¯ÙŠØ±)</span></h3>
            <input type="text" id="stockSearch" placeholder="ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..." onkeyup="renderStock()">
            <div style="overflow-x: auto;">
                <table id="stockTbl">
                    <thead><tr><th>Ø§Ù„Ù…Ø§Ø±ÙƒØ©</th><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„ØªÙƒÙ„ÙØ©</th><th>Ø§Ù„Ø¨ÙŠØ¹</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                    <tbody id="stockBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="reportsPage" class="page">
        <div class="card">
            <h3>ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h3>
            <div id="repLock">
                <input type="password" id="fKey" placeholder="ÙƒÙˆØ¯ Ø§Ù„ÙˆØµÙˆÙ„ (1988)">
                <button class="btn-main" onclick="unlockRep()">ÙØªØ­ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
            </div>
            <div id="repContent" style="display: none;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="card" style="background: #e0f2fe; text-align: center; margin:0;"><h5>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h5><b id="totS" style="font-size:20px;">0</b></div>
                    <div class="card" style="background: #dcfce7; text-align: center; margin:0;"><h5>Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨</h5><b id="totT" style="font-size:20px;">0</b></div>
                </div>
            </div>
        </div>
    </div>

    <div id="custPage" class="page">
        <div class="card">
            <h3>ğŸ‘¥ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª</h3>
            <table>
                <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                <tbody id="custBody"></tbody>
            </table>
        </div>
    </div>

    <div id="adminPage" class="page">
        <div class="card" id="adminArea">
            <h3>âš™ï¸ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
            <div style="background: #f1f5f9; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <h4>ğŸ” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù…Ø§Ù†</h4>
                <input id="upAdmin" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
                <input id="upStaff" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
                <input id="upFin" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
                <button class="btn-main" onclick="updateSecurity()">ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</button>
            </div>
            <div style="background: #eef2ff; padding: 15px; border-radius: 10px;">
                <h4>ğŸ†• Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯</h4>
                <input id="nb" placeholder="Ø§Ù„Ù…Ø§Ø±ÙƒØ©">
                <input id="nn" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù">
                <input id="nc" type="number" placeholder="Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ©">
                <input id="np" type="number" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ù…Ù‚ØªØ±Ø­">
                <input id="nq" type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
                <button class="btn-ok" onclick="addNewProduct()">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø®Ø²Ù†</button>
            </div>
        </div>
    </div>
</div>

<div id="invModal" class="modal">
    <div class="invoice-box" id="printableInvoice">
        <div class="inv-header">
            <div>
                <h1 style="margin:0; color:var(--brand); font-size: 24px;">Ø£Ø¹Ù…Ø§Ù„ Ù…ÙŠÙˆØ²ØªÙƒ Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©</h1>
                <p style="margin:2px; font-size:11px;">MUSTECH TRADING - Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ: 130009077201</p>
                <p style="margin:2px; font-size:11px;">Ù‡Ø§ØªÙ: 0917029008 - 0912949561</p>
            </div>
            <div style="text-align: left;">
                <h3 style="margin:0;">INVOICE</h3>
                <p id="invDateDisplay" style="font-size:11px;"></p>
            </div>
        </div>
        
        <div id="invTag" class="normal-badge">ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª</div>

        <div style="margin: 15px 0; font-size: 13px;">
            <strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> <span id="viewC"></span> | <strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> <span id="viewP"></span>
        </div>

        <table>
            <thead style="background:var(--brand); color:#fff;">
                <tr><th>#</th><th>Ø§Ù„Ø¨ÙŠØ§Ù†</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr>
            </thead>
            <tbody id="viewItems"></tbody>
        </table>

        <div style="display: flex; justify-content: space-between; margin-top: 20px; align-items: flex-end;">
            <div id="qrcode"></div>
            <div style="width: 200px;" id="viewSummary"></div>
        </div>

        <div style="margin-top: 40px; text-align: center; font-size: 10px; border-top: 1px solid #eee; padding-top: 10px;">
            Ø¨Ø¶Ø§Ø¹Ø© Ù„Ø§ ØªØ±Ø¯ ÙˆÙ„Ø§ ØªØ³ØªØ¨Ø¯Ù„ Ø¨Ø¹Ø¯ 3 Ø£ÙŠØ§Ù… - Ø´ÙƒØ±Ø§Ù‹ Ù„Ø«Ù‚ØªÙƒÙ… Ø¨Ù†Ø§
        </div>
    </div>
    <div style="text-align: center; padding: 20px;" class="no-print">
        <button class="btn-ok" style="width:150px; margin-bottom:5px;" onclick="processSale()">Ø­ÙØ¸ ÙˆØ¨ÙŠØ¹ âœ…</button>
        <button class="btn-main" style="width:150px; margin-bottom:5px;" onclick="downloadPDF()">ØªØ­Ù…ÙŠÙ„ PDF ğŸ“¥</button>
        <button onclick="invModal.style.display='none'" style="background:#94a3b8; color:#fff; padding:10px; border-radius:10px; border:none; width:150px;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<nav id="navBar" style="display: none;">
    <button onclick="nav('posPage', this)" class="active">ğŸ  Ø§Ù„Ø¨ÙŠØ¹</button>
    <button onclick="nav('stockPage', this)">ğŸ“¦ Ø§Ù„Ù…Ø®Ø²Ù†</button>
    <button onclick="nav('reportsPage', this)">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
    <button onclick="nav('custPage', this)">ğŸ‘¥ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
    <button onclick="nav('adminPage', this)">âš™ï¸ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
</nav>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyABUumECfr2cnT0a3Btjf6aNhCwmlW732U",
        authDomain: "mustech-erp.firebaseapp.com",
        databaseURL: "https://mustech-erp-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "mustech-erp",
        storageBucket: "mustech-erp.firebasestorage.app",
        messagingSenderId: "961861724364",
        appId: "1:961861724364:web:a381a37add3569c613ba69"
    };
    firebase.initializeApp(firebaseConfig);
    const rdb = firebase.database();

    let db = { items: [], sales: [], customers: [], config: { admin: "7878", staff: "0909", fin: "1988" } };
    let userRole = ""; 
    let cart = [];

    rdb.ref('mustech_cloud_v4').on('value', snap => {
        if (snap.val()) { db = snap.val(); sync(); }
    });

    function save() { rdb.ref('mustech_cloud_v4').set(db); }

    function auth() {
        let p = entryPass.value;
        if (p === db.config.admin) userRole = "admin";
        else if (p === db.config.staff) userRole = "staff";
        else return alert("Ø®Ø·Ø£ ÙÙŠ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±!");
        
        loginView.style.display = "none";
        appView.style.display = "block";
        navBar.style.display = "flex";
        if(userRole === "admin") {
            mgrTag.style.display = "inline";
        } else {
            adminArea.innerHTML = "<h3 style='color:red; text-align:center;'>ğŸš« ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·</h3>";
        }
    }

    function nav(id, btn) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
    }

    function sync() {
        itemSelect.innerHTML = db.items ? db.items.map((it, i) => `<option value="${i}">${it.brand} - ${it.name} (${it.qty})</option>`).join('') : '';
        renderStock();
        renderCust();
        updatePriceLabel();
    }

    function updatePriceLabel() {
        if(!db.items || !db.items[itemSelect.value]) return;
        let it = db.items[itemSelect.value];
        let min = it.cost * 1.45;
        minPriceLbl.innerText = `Ø£Ø¯Ù†Ù‰ Ø³Ø¹Ø±: ${Math.ceil(min)}`;
        sPrice.value = it.price || Math.ceil(min);
    }

    function addToCart() {
        let it = db.items[itemSelect.value];
        let p = parseFloat(sPrice.value);
        let q = parseInt(sQty.value);
        if (p < (it.cost * 1.45)) return alert("Ø§Ù„Ø³Ø¹Ø± Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ (45%)!");
        if (q > it.qty) return alert("Ø§Ù„ÙƒÙ…ÙŠØ© ØºÙŠØ± ÙƒØ§ÙÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù†!");
        
        cart.push({ ...it, selP: p, selQ: q, originalIdx: itemSelect.value });
        renderCart();
    }

    function renderCart() {
        let h = '', sub = 0;
        cart.forEach((c, i) => {
            h += `<tr><td>${c.name}</td><td>${c.selP}</td><td>${c.selQ}</td><td onclick="cart.splice(${i},1);renderCart()">âŒ</td></tr>`;
            sub += c.selP * c.selQ;
        });
        document.querySelector('#cartTbl tbody').innerHTML = h;
        let total = taxToggle.checked ? sub * 1.17 : sub;
        cartTotalDisplay.innerText = Math.ceil(total).toLocaleString() + " SDG";
    }

    function openPreview() {
        if (!cart.length) return alert("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©!");
        let sub = cart.reduce((a, b) => a + (b.selP * b.selQ), 0);
        let isTax = taxToggle.checked;
        let taxVal = isTax ? sub * 0.17 : 0;
        let total = sub + taxVal;

        viewC.innerText = cName.value || "Ø¹Ù…ÙŠÙ„ Ù†Ù‚Ø¯ÙŠ";
        viewP.innerText = cPhone.value || "---";
        invDateDisplay.innerText = new Date().toLocaleString();
        
        invTag.className = isTax ? "tax-badge" : "normal-badge";
        invTag.innerText = isTax ? "ÙØ§ØªÙˆØ±Ø© Ø¶Ø±ÙŠØ¨ÙŠØ© (TAX INVOICE)" : "ÙØ§ØªÙˆØ±Ø© Ù…Ø¨ÙŠØ¹Ø§Øª";

        viewItems.innerHTML = cart.map((c, i) => `<tr><td>${i+1}</td><td>${c.brand} ${c.name}</td><td>${c.selQ}</td><td>${c.selP}</td><td>${c.selP*c.selQ}</td></tr>`).join('');
        
        viewSummary.innerHTML = `
            <table style="width:100%; font-size:12px;">
                <tr><td>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</td><td style="text-align:left;">${sub}</td></tr>
                ${isTax ? `<tr><td>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© 17%:</td><td style="text-align:left;">${Math.ceil(taxVal)}</td></tr>` : ''}
                <tr style="font-weight:bold; color:var(--brand); font-size:14px; border-top:1px solid #000;"><td>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</td><td style="text-align:left;">${Math.ceil(total)} SDG</td></tr>
            </table>
        `;

        qrcode.innerHTML = "";
        new QRCode(qrcode, { text: "MUSTECH-" + Math.ceil(total), width: 70, height: 70 });
        invModal.style.display = "block";
    }

    function processSale() {
        let sub = cart.reduce((a, b) => a + (b.selP * b.selQ), 0);
        let taxVal = taxToggle.checked ? sub * 0.17 : 0;
        let total = sub + taxVal;
        let paid = paidAmt.value === "" ? total : parseFloat(paidAmt.value);

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²Ù†
        cart.forEach(c => { db.items[c.originalIdx].qty -= c.selQ; });

        // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©
        if (cName.value && paid < total) {
            if (!db.customers) db.customers = [];
            let existing = db.customers.find(cust => cust.phone === cPhone.value);
            let debt = total - paid;
            if (existing) { existing.balance += debt; }
            else { db.customers.push({ name: cName.value, phone: cPhone.value, balance: debt }); }
        }

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
        if (!db.sales) db.sales = [];
        db.sales.push({ date: Date.now(), total: sub, tax: taxVal, paid: paid });

        save();
        alert("ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!");
        cart = [];
        invModal.style.display = "none";
        renderCart();
    }

    function renderStock() {
        if (!db.items) return;
        let q = stockSearch.value.toLowerCase();
        let isMgr = userRole === "admin";
        stockBody.innerHTML = db.items.map((it, i) => {
            if (!it.name.toLowerCase().includes(q) && !it.brand.toLowerCase().includes(q)) return '';
            return `<tr class="${it.qty < 3 ? 'low-stock' : ''}">
                <td>${it.brand}</td>
                <td>${it.name}</td>
                <td>${isMgr ? `<input type="number" value="${it.cost}" style="width:70px; padding:5px; margin:0;" onchange="updateItem(${i},'cost',this.value)">` : 'ğŸ”’'}</td>
                <td><input type="number" value="${it.price}" style="width:70px; padding:5px; margin:0;" onchange="updateItem(${i},'price',this.value)" ${!isMgr?'disabled':''}></td>
                <td><input type="number" value="${it.qty}" style="width:60px; padding:5px; margin:0;" onchange="updateItem(${i},'qty',this.value)" ${!isMgr?'disabled':''}></td>
                <td>${isMgr ? `<button onclick="deleteItem(${i})" style="color:red; border:none; background:none; cursor:pointer;">ğŸ—‘ï¸</button>` : '---'}</td>
            </tr>`;
        }).join('');
    }

    function updateItem(i, field, val) { db.items[i][field] = parseFloat(val); save(); }
    function deleteItem(i) { if(confirm("Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) { db.items.splice(i, 1); save(); } }

    function renderCust() {
        if (!db.customers) return;
        custBody.innerHTML = db.customers.map((c, i) => `<tr><td>${c.name}</td><td>${c.phone}</td><td style="color:red; font-weight:bold;">${Math.ceil(c.balance)}</td><td><button onclick="payDebt(${i})" style="padding:5px 10px; border-radius:5px; border:none; background:var(--ok); color:#fff; cursor:pointer;">Ø³Ø¯Ø§Ø¯</button></td></tr>`).join('');
    }

    function payDebt(i) {
        let amt = prompt(`Ø³Ø¯Ø§Ø¯ Ù…Ø¨Ù„Øº Ù…Ù† Ø£ØµÙ„ ${db.customers[i].balance}:`);
        if (amt) { db.customers[i].balance -= parseFloat(amt); save(); }
    }

    function unlockRep() { if (fKey.value === db.config.fin) { repLock.style.display = "none"; repContent.style.display = "block"; calcRep(); } else alert("Ø®Ø·Ø£!"); }
    
    function calcRep() {
        if (!db.sales) return;
        let totalSales = db.sales.reduce((a, b) => a + b.total, 0);
        let totalTax = db.sales.reduce((a, b) => a + b.tax, 0);
        totS.innerText = Math.ceil(totalSales).toLocaleString();
        totT.innerText = Math.ceil(totalTax).toLocaleString();
    }

    function addNewProduct() {
        if (!db.items) db.items = [];
        db.items.push({ brand: nb.value, name: nn.value, cost: parseFloat(nc.value), price: parseFloat(np.value), qty: parseInt(nq.value) });
        save();
        alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­");
        nb.value=nn.value=nc.value=np.value=nq.value="";
    }

    function updateSecurity() {
        if (upAdmin.value) db.config.admin = upAdmin.value;
        if (upStaff.value) db.config.staff = upStaff.value;
        if (upFin.value) db.config.fin = upFin.value;
        save();
        alert("ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø³Ø±");
    }

    function downloadPDF() {
        const opt = { margin: 0, filename: 'Mustech_Invoice.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
        html2pdf().set(opt).from(document.getElementById('printableInvoice')).save();
    }
</script>
</body>
</html>

